!function(t,e){"use strict";function n(e){var n={editor:l(l.create("div",{className:"editor"})),tools:l(l.create("div",{className:"tools",unSelectable:"on",innerHTML:i(e.tools)})),content:l(l.create("div",{className:"content",contentEditable:"true"}))};return n.editor.append(n.tools,n.content),n.content.css("minHeight",t.document.body.clientHeight+"px"),e.textarea.before(n.editor),e.textarea.hide(),n}function i(t){var e,n="";for(e in h)(!t||!t.length||l.inArray(h[e].name,t)>-1)&&(n+='<button title="'+h[e].tip+'" name="'+h[e].name+'">'+h[e].icon+"</button>");return n}function o(t,e){t.bind("click",function(t){"BUTTON"==t.target.tagName&&t.target.name in e&&e[t.target.name](),e.saveRange()})}function a(e,n){var i,o,a;e.bind("click",function(e){for(i=t.getSelection(),o=!1,a=e.target;a!=n.content[0]&&!o;){switch(a.tagName){case"A":i.selectAllChildren(a),n.createLink(a.href,"_blank"==a.target),e.preventDefault(),o=!0}a=a.parentNode}n.saveRange(i.getRangeAt(0))})}function r(){return{link:l.create("div",{className:"link"}),input:l.create("input",{type:"text",placeholder:"请输入链接"}),checkbox:l.create("input",{type:"checkbox"}),label:l.create("label",{innerHTML:"新窗口打开"})}}function s(){var t,e="";for(t=1;31>t;t++)e+='<img src="emotion/'+(10>t?"0"+t:t)+'.gif">';return e}function c(){var t="";return t+='<div class="tab"><span class="active" rel="local">上传图片</span><span rel="net">网络图片</span></div>',t+='<div class="queue"></div>',t+='<div class="upload_local">',t+='<input type="file" accept="image/gif, image/jpeg, image/x-png" class="upload_file" multiple="true" />',t+='<input type="button" class="upload_btn" value="选择图片" />',t+="</div>",t+='<div class="upload_net" style="display:none">',t+='<input type="text" class="fetch_url" value="http://" />',t+='<input type="button" class="fetch_btn" value="获取图片" />',t+="</div>"}var l,u,d,h,p,f;l=function(t,e){return new l.prototype.__init__(t,e)},l.prototype={constructor:l,__init__:function(e,n){if("string"===l.type(e))e=(n||t.document).querySelectorAll(e);else{if(!e.nodeType)return this;e=[e]}return l.extend(this,{0:e.length>1?e:e[0],length:e.length,context:n})},each:function(t){return l.each(this.length>1?this[0]:[this[0]],t)},eq:function(t){return 0==t||this.length<2?this:l(this[0][t])},show:function(){return 1==this.length?this[0].style.display="":l.eachCall("show",this[0]),this},hide:function(){return 1==this.length?this[0].style.display="none":l.eachCall("hide",this[0]),this},attr:function(t,e){return"string"!=typeof e?this[0].getAttribute(t):function(n){return"string"==typeof t?n[0].setAttribute(t,e):l.each(t,function(t,e){n[0].setAttribute(e,t)}),n}(this)},css:function(t,e){return"undefined"==typeof e&&"string"==typeof t?this[0].style[t]:function(n){return"string"==typeof t?n[0].style[t]=e:l.each(t,function(t,e){n[0].style[e]=t}),n}(this)},html:function(t){return"string"!=typeof t?this[0].innerHTML:function(e){return e[0].innerHTML=t,e}(this)},append:function(){var t,e;for(t=0;t<arguments.length;t++)e="string"==typeof arguments[t]?l.htmlToFragment(arguments[t]):arguments.constructor?arguments[t][0]:arguments[t],this[0].appendChild(e);return this},appendTo:function(t){return(t[0]||t).appendChild(this[0]),this},before:function(t){return t&&this[0].parentNode&&this[0].parentNode.insertBefore(t.constructor?t[0]:t,this[0]),this},width:function(t){return"undefined"==typeof t?parseInt(this[0].style.width||this[0].offsetWidth):function(e){return e[0].style.width=t+"px",e}(this)},height:function(t){return"undefined"==typeof t?parseInt(this[0].style.height||this[0].offsetHeight):function(e){return e[0].style.height=t+"px",e}(this)},offset:function(t){return t=t||{top:0,left:0},t.top+=this[0].offsetTop,t.left+=this[0].offsetLeft,"BODY"!=this[0].offsetParent.tagName&&(t=this.offset(this[0].offsetParent,t)),t},bind:function(t,e){return l.addEvent(this[0],t,e),this}},l.htmlToFragment=function(e){for(var n=t.document.createDocumentFragment(),i=this.create("div",{innerHTML:e});i.firstChild;)n.appendChild(i.firstChild);return n},l.addEvent=function(t,e,n){t.addEventListener(e,n,!1)},l.extend=function(t,e){for(var n in e)t[n]=e[n];return t},l.type=function(t){var e;return null==t||"undefined"==t?e=t:(e=Object.prototype.toString.call(t).split(" ")[1],e=e.replace("]","").toLowerCase(),e.indexOf("node")>-1&&(e="node")),e},l.eachCall=function(t,e){l.each(e,function(e){l.prototype[t].call([e])})},l.isArray=function(t){return"array"===this.type(t)},l.each=function(t,e){for(var n in t)e.apply(t[n],[t[n],n])},l.create=function(e,n){if(e=t.document.createElement(e),"undefined"!=typeof n){var i,o;i=function(t,e){for(o in e)"string"==typeof e[o]||e[o].length?t[o]=e[o]:i(t[o],e[o])},i(e,n)}return e},l.inArray=function(t,e){var n,i=-1;if(Array.prototype.indexOf)e.indexOf(t);else for(n=0;n<e.length;n++)if(e[n]===t){i=n;break}return i},l.contains=function(t,e){return"contains"in t?t.contains(e):"compareDocumentPosition"in t?t.compareDocumentPosition(e)%16:!1},l.extend(l,function(t){function e(){var t;try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){t=new XMLHttpRequest}}return t}function n(t,e){t.data=i(t.method,t.data),"get"==t.method&&t.data&&(t.url+=(/\?/.test(t.url)?"&":"?")+t.data),e.open(t.method,t.url,t.async),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){o(t.success,t.error,t.type,e)},e.send(t.data)}function i(t,e){if(!e||e.length<1)return null;var n=[];for(var i in e)n.push(i+"="+a(e[i]));return n.join("&")}function o(t,e,n,i){if(4==i.readyState)if(200==i.status){var o=i.response||i.responseText;if("json"==n.toLowerCase())try{o=JSON.parse(o)}catch(a){}t(o,"success")}else e(i.readyState,i.status)}function a(t){return/^data:image\/\w+;base64/i.test(t)?t.replace(/\+/g,"%2B").replace(/\&/g,"%26"):encodeURI(t).replace(/&/g,"%26").replace(/\+/g,"%2B").replace(/\s/g,"%20").replace(/#/g,"%23")}return{ajax:function(i){n(t.extend({method:"get",url:null,async:!0,data:null,type:"json",success:function(){},error:function(){}},i),e())},post:function(t,e,n,i){this.ajax({method:"post",url:t,data:e,success:n,type:i||"json"})},get:function(t,e,n,i){e instanceof Function&&(i=n,n=e,e=null),this.ajax({method:"get",url:t,data:e,success:n,type:i||"json"})}}}(l)),l.prototype.__init__.prototype=l.prototype,u=function(t){this.options=l.extend({allow_ext:["jpeg","jpg","png","gif"],maxsize:2048,upload_url:"upload.php",fetch_url:"fetch.php",uploadBefore:function(t,e){},callback:function(t,e){}},t)},u.prototype={constructor:u,count:1,checkSubfix:function(t){return l.inArray(t.substring(t.lastIndexOf(".")+1).toLowerCase(),this.options.allow_ext)},checkHost:function(t){return/^(https?:)?\/\/\w+\.(feidee|cardniu)\.(com|net)/i.test(t)},startUpload:function(t){var e=new FileReader,n=this;e.readAsDataURL(t),e.onload=function(){l.post(n.options.upload_url,{file:this.result},function(e){1==e.code&&n.options.callback(e.items,t.index)}),e=null}},reader:function(t){var e=new FileReader,n=this;e.readAsDataURL(t),e.onload=function(){n.options.uploadBefore(this.result,t.index),e=null}},upload:function(t){var e;for(e=0;e<t.length;e++)this.checkSubfix(t[e].name)&&(t[e].index=this.count,this.count++,this.reader(t[e]));for(e=0;e<t.length;e++)this.checkSubfix(t[e].name)&&this.startUpload(t[e])},fetch:function(t){this.checkSubfix(t)&&this.checkHost(t)&&this.options.callback({code:1,url:t})}},f=function(t){return new f.prototype.__init__(t)},f.prototype={constructor:f,__init__:function(t){this.options=l.extend({width:200,height:0,title:"通知",content:"",confirm:null},t),this.create()},create:function(){var t=this;return l.extend(this,{dialog:l.create("div",{className:"dialog",innerHTML:'<div class="title"><span></span><i class="iconfont">&#xe609;</i></div>'}),content:l.create("div",{className:"content"})}),this.dialog.appendChild(this.content),this.title=this.dialog.querySelector(".title span"),l.addEvent(this.dialog.querySelector(".title i"),"click",function(){t.hide()}),this.setContent(this.options.content).setTitle(this.options.title),this.options.confirm&&this.confirm(this.options.confirm),this},setTitle:function(t){return this.title.innerHTML=t,this},setContent:function(t){return"string"==typeof t?this.content.innerHTML=t:(this.content.innerHTML="",this.content.appendChild(t)),this},confirm:function(t){var e;return e=l.create("div",{className:"confirm"}),this.confirm=l.create("input",{type:"button",value:"确定"}),e.appendChild(this.confirm),this.dialog.appendChild(e),l.addEvent(this.confirm,"click",function(){t()}),this},setAttribute:function(){return this.options.height>50&&(this.content.style.height=this.options.height+"px"),l.extend(this.dialog.style,{width:this.options.width+"px",top:"100px",left:(t.screen.availWidth-this.options.width)/2+"px"}),t.document.body.appendChild(this.dialog),!0},show:function(){return this.exist||(this.exist=this.setAttribute()),this.dialog.style.display="",this},hide:function(){return this.dialog.style.display="none",this}},f.prototype.__init__.prototype=f.prototype,f.cover=function(){function e(){return l.create("div",{className:"cover",style:{height:t.screen.availHeight+"px"}})}return{show:function(){e.cover||(e.cover=l(e()).appendTo(t.document.body)),e.cover.show()},hide:function(){e.cover.hide()}}}(),f.tip=function(){function e(){return l.create("div",{className:"tip"})}return function(n){e.tip||(e.tip=l(e()).appendTo(t.document.body)),e.tip.html(n).show().css({top:"100px",left:(t.document.body.offsetWidth-e.tip.width())/2+"px"}),setTimeout(function(){e.tip.hide()},2500)}}(),p=["#000000","#fff","#000066","#000099","#0000CC","#0000FF","#0033CC","#0033FF","#006600","#006633","#006666","#006699","#009966","#009999","#0099CC","#0099FF","#00CC00","#00CC33","#666600","#666666","#6666CC","#669900","#669966","#6699CC","#66CCCC","#66CCFF","#66FF00","#66FF99","#66FFFF","#990000","#996600","#996666","#9966CC","#9966FF","#999900","#999966","red","#CC3366","#CC9966","#CC9999","#CCCC00","#F78B00"],h=[{name:"cleanFormat",icon:"&#xe60b;",tip:"清除格式"},{name:"justifyLeft",icon:"&#xe60d;",tip:"左对齐"},{name:"justifyCenter",icon:"&#xe60f;",tip:"居中对齐"},{name:"justifyRight",icon:"&#xe60e;",tip:"右对齐"},{name:"bold",icon:"&#xe608;",tip:"加粗"},{name:"table",icon:"&#xe607;",tip:"表格"},{name:"insertUnorderedList",icon:"&#xe606;",tip:"无序列表"},{name:"insertOrderedList",icon:"&#xe601;",tip:"有序列表"},{name:"insertImage",icon:"&#xe605;",tip:"图片"},{name:"color",icon:"&#xe604;",tip:"文字颜色"},{name:"createLink",icon:"&#xe603;",tip:"超链接"},{name:"unLink",icon:"&#xe602;",tip:"取消超链接"},{name:"video",icon:"&#xe600;",tip:"视频"},{name:"emotion",icon:"&#xe612;",tip:"表情"},{name:"undo",icon:"&#xe610;",tip:"撤销操作"}],d=function(t){this.options=l.extend({textarea:null,width:null,height:null,allowImage:!0,allowUploadImage:!0,uploadImageUrl:null,tools:null},t),this.data={},"string"==typeof this.options.textarea&&(this.options.textarea=l(this.options.textarea)),l.extend(this,n(this.options)),o(this.tools,this),a(this.content,this)},d.prototype={constructor:d,focus:function(){return this.editor[0].focus(),this},getSelection:function(){return t.getSelection()},saveRange:function(t){return this.data.range=t?t.cloneRange():function(t,e){return t.rangeCount?t.getRangeAt(0).cloneRange():e.data.range||null}(this.getSelection(),this),this},recoveryRange:function(){return this.focus(),this.data.range&&(this.data.selection=this.getSelection(),this.data.selection.removeAllRanges(),this.data.selection.addRange(this.data.range),this.data.range=this.data.selection.getRangeAt(0)),this},execCommand:function(e,n,i){return t.document.execCommand(e,n||!1,i||null)},insertAtRange:function(t,e){var n;return"string"==typeof t&&(t=l.htmlToFragment(t)),e=e||this.getSelection(),n=e.getRangeAt(0),n.deleteContents(),n.insertNode(t),e.addRange(n),this},searchParent:function(t,e){return"string"==typeof e?(t&&!t.tagName||t.tagName!=e&&t.parentNode)&&(t=this.searchParent(t.parentNode,e)):t!=e&&t.parentNode&&(t=this.searchParent(t.parentNode,e)),("string"==typeof e?t.tagName:t)==e?t:null},isContains:function(t,e){return"string"==typeof e?t.tagName!=e&&t.firstChild?t=t.querySelector(e):t.tagName!=e&&(t=null):t!=e&&(t=l.contains(t,e)),t?!0:!1},getContent:function(){return this.content.html()},setContent:function(t){return this.content.html(t),this},cleanFormat:function(){var t,e,n;return t=this.getSelection(),n=l.htmlToFragment(t.toString()),e=t.getRangeAt(0),e.deleteContents(),e.insertNode(n),t.addRange(e),this.execCommand("RemoveFormat")},justifyLeft:function(){return this.execCommand("justifyLeft"),this},justifyCenter:function(){return this.execCommand("justifyCenter"),this},justifyRight:function(){return this.execCommand("justifyRight"),this},bold:function(){return this.execCommand("bold",!1,[]),this},table:function(){if(!this.data.tableDialog){var t,e,n,i,o=this,a="";this.data.tableDialog=f({title:"表格",width:150,height:60,content:'<div class="table-num"><input type="text" class="row" placeholder="行" /><input type="text" class="col" placeholder="列" /></div>'}),this.data.tableDialog.confirm(function(){if(t=o.data.tableDialog.content.querySelector(".row").value,e=o.data.tableDialog.content.querySelector(".col").value,1>t||1>e||e>5)f.tip("行和列必须大于0,且列数不得大于5");else{for(a='<table class="table">',n=0;t>n;n++){for(a+="<tr>",i=0;e>i;i++)a+="<td></td>";a+="</tr>"}a+="</table>",o.recoveryRange(),o.insertAtRange(a)}})}this.data.tableDialog.show()},insertUnorderedList:function(){this.execCommand("insertUnorderedList",!1,null)},insertOrderedList:function(){this.execCommand("insertOrderedList",!1,null)},insertImage:function(){if(!this.data.upload){var t=l.create("div",{className:"upload",innerHTML:c()}),e=this;this.data.upload=f({title:"添加图片",width:500,height:500,content:t}),this.data.uploadDialog={queue:t.querySelector(".queue"),upload_local:t.querySelector(".upload_local"),upload_net:t.querySelector(".upload_net"),fetch_url:t.querySelector(".fetch_url")},l.addEvent(t.querySelector(".tab"),"click",function(t){var n;"SPAN"==t.target.tagName&&(n=t.target.nextSibling||t.target.previousSibling,t.target.className="active",n.className="",e.data.uploadDialog["upload_"+n.getAttribute("rel")].style.display="none",e.data.uploadDialog["upload_"+t.target.getAttribute("rel")].style.display="")}),l.addEvent(t.querySelector(".upload_file"),"change",function(){var t;e.data.uploadContext||(e.data.uploadContext=new u({uploadBefore:function(t,n){e.data.uploadDialog.queue.innerHTML+='<div class="upload_img"><img data-index="'+n+'" src="'+t+'"><div class="upload_cover">加载中...</div></div>'},callback:function(n,i){t=e.data.uploadDialog.queue.querySelector('img[data-index="'+i+'"]'),t.dataset.src=n,t.nextSibling.style.display="none"}})),e.data.uploadContext.upload(this.files)}),l.addEvent(t.querySelector(".fetch_btn"),"click",function(){e.data.uploadDialog.fetch_url.value?e.data.uploadDialog.queue.innerHTML+='<div><img data-src="'+e.data.uploadDialog.fetch_url.value+'" src="'+e.data.uploadDialog.fetch_url.value+'"></div>':f.tip("请输入正确的图片地址")}),l.addEvent(this.data.uploadDialog.queue,"click",function(t){"IMG"==t.target.tagName&&e.insertAtRange('<img src="'+t.target.dataset.src+'">')})}this.data.upload.show()},uploadImage:function(){this.data.upload||(this.data.upload=f({title:"添加图片",width:500,height:300,content:""})),this.data.show()},color:function(){if(!this.data.colorDialog){var t='<div class="color">',e=this;l.each(p,function(e){t+='<input type="button" style="background:'+e+'" />'}),this.data.colorDialog=f({title:"调色板",width:200,content:t}),l.addEvent(this.data.colorDialog.content.querySelector(".color"),"click",function(t){e.execCommand("foreColor",!1,t.target.style.background)})}this.data.colorDialog.show()},createLinkCommand:function(t,e){var n;this.recoveryRange(),this.execCommand("createLink",!1,t),n=this.getSelection(),e&&"A"==n.anchorNode.parentNode.tagName&&n.anchorNode.parentNode.setAttribute("target","_blank"),this.data.link.hide()},createLink:function(t,e){if(!this.data.link){var n=this,i={};l.extend(i,r()),i.link.appendChild(i.input),i.link.appendChild(i.checkbox),i.link.appendChild(i.label),this.data.link=f({title:"添加链接",width:250,height:80,content:i.link,confirm:function(){/\/\//.test(i.input.value)?n.createLinkCommand(i.input.value,i.checkbox.checked):f.tip("链接格式错误")}}),this.data.linkvar=i}t&&(this.data.linkvar.input.value=t),e&&(this.data.linkvar.checkbox.checked=!0),this.data.link.show()},unLink:function(){return this.execCommand("unLink",!1,null),this},video:function(){if(!this.data.videoDialog){var t,e,n,i=this;this.data.videoDialog=f({title:"添加视频",width:400,height:80,content:'<div class="video"><label>填写视频网址即可，暂时只支持优酷和腾讯视频</label><input class="url" type="text" value="http://"></div>'}),this.data.videoDialog.confirm(function(){t=i.data.videoDialog.content.querySelector(".url").value,n="",t.length<20?f.tip("链接格式错误"):/(https?:\/\/)?\w+\.youku\.com/i.test(t)&&(e=t.match(/id_(\w+)/i))&&e[1]?n="http://player.youku.com/embed/"+e[1]:/(https?:\/\/)?\w+\.qq\.com/i.test(t)&&(e=t.match(/vid=(\w+)/i))&&e[1]?n="http://v.qq.com/iframe/player.html?vid="+e[1]+"&tiny=0&auto=0":f.tip("暂时只支持优酷和腾讯视频"),n&&(i.recoveryRange(),i.insertAtRange('<iframe src="'+n+'" frameborder=0 allowfullscreen="true"></iframe>'))})}this.data.videoDialog.show()},emotion:function(){if(!this.data.emotion){var t=l.create("div",{className:"emotion",innerHTML:s()}),e=this;this.data.emotion=f({title:"添加表情",width:240,content:t}),l.addEvent(t,"click",function(t){e.saveRange(),"IMG"==t.target.tagName&&(e.recoveryRange(),e.execCommand("insertImage",!1,t.target.src))})}this.data.emotion.show()},undo:function(){this.execCommand("undo")}},t[e]=function(t){return new d(t).focus()}}(window,"Editor");